---
title: "CMAA Census Data Mapping & Analysis"
subtitle: American Community Survey Data, 2010-2015 (Estimated)
output:
  pdf_document: default
  html_notebook: default
  html_document: default
---
This is an R notebook designed to document the process of creating interactive maps using data from the American Community Survey. It uses leaflet for mapping and R for analysis and aggregation. The code can be adapted to use different census datasets; see `acs.lookup`. 

First thing is to get a census data api key [here](http://api.census.gov/data/key_signup.html). Load the acs library and then install your api key using `api.key_install`.

Next, set up the environment, the necessary packages, and the relevant mapping data:

```{r setup_libraries, results='hide', message=FALSE, tidy=TRUE}
require(tidyverse)
require(tigris)
require(acs)
require(stringr)
require(leaflet)
```


```{r get_chi_spatial, results='hide', message=FALSE}
#Getting spatial data of Chicagoland counties 
chi_spa_counties <- c(31, 43, 89, 93, 97, 111, 197) 
chi_spa_tracts <- tracts(state = "IL", county = chi_spa_counties, cb=TRUE)
chi_tab_geo <- geo.make(state = c("IL"), county=chi_spa_counties, tract="*")
```


```{r get_chi_income_tab, results='hide'}
#Getting tabular data of income level using the census api (Table B19001)
chi_income_tab <- acs.fetch(endyear = 2015, span = 5, geography = chi_tab_geo, table.number = "B19001", col.names = "pretty")
chi_income_tab_df <- data.frame(paste0(str_pad(chi_income_tab@geography$state, 2, "left", pad="0"), str_pad(chi_income_tab@geography$county, 3, "left", pad="0"), str_pad(chi_income_tab@geography$tract, 6, "left", pad="0")), chi_income_tab@estimate[,c("B19001. Household Income in the Past 12 Months (in 2015 Inflation-Adjusted Dollars): Total:","B19001. Household Income in the Past 12 Months (in 2015 Inflation-Adjusted Dollars): Less than $10,000", "B19001. Household Income in the Past 12 Months (in 2015 Inflation-Adjusted Dollars): $10,000 to $14,999", "B19001. Household Income in the Past 12 Months (in 2015 Inflation-Adjusted Dollars): $15,000 to $19,999")], stringsAsFactors = FALSE)
rownames(chi_income_tab_df)<-1:nrow(chi_income_tab_df)
names(chi_income_tab_df)<-c("GEOID", "total", "under_10k", "under_15k", "under_20k")
chi_income_tab_df$combined <- rowSums(chi_income_tab_df[,c("under_10k", "under_15k", "under_20k")])
chi_income_tab_df$percent <- 100*(chi_income_tab_df$combined/chi_income_tab_df$total)
```
```{r get_chi_income_mer, results='hide'}
#Merging spatial data and tabular data using GEOID
chi_income_mer <- geo_join(chi_spa_tracts, chi_income_tab_df, "GEOID", "GEOID")
chi_income_mer <- chi_income_mer[chi_income_mer$ALAND>0,]
```


```{r get_chi_citstatus_tab, results='hide'}
#Getting tabular data on race (Table B02001)
chi_citstatus_tab <- acs.fetch(endyear = 2015, span = 5, geography = chi_tab_geo, table.number = "B05001", col.names = "pretty")
chi_citstatus_tab_df <- data.frame(paste0(str_pad(chi_citstatus_tab@geography$state, 2, "left", pad="0"), str_pad(chi_citstatus_tab@geography$county, 3, "left", pad="0"), str_pad(chi_citstatus_tab@geography$tract, 6, "left", pad="0")), chi_citstatus_tab@estimate[,c("Nativity and Citizenship Status in the United States: Total:" , "Nativity and Citizenship Status in the United States: U.S. citizen by naturalization", "Nativity and Citizenship Status in the United States: Not a U.S. citizen")], stringsAsFactors = FALSE)
rownames(chi_citstatus_tab_df)<-1:nrow(chi_citstatus_tab_df)
names(chi_citstatus_tab_df)<-c("GEOID", "total", "natural", "noncitizen")
chi_citstatus_tab_df$combined <- rowSums(chi_citstatus_tab_df[,c("natural", "noncitizen")])
chi_citstatus_tab_df$percent <- 100*(chi_citstatus_tab_df$combined/chi_citstatus_tab_df$total)
```
```{r get_chi_citstatus_mer, results='hide'}
#Merging spatial data and tabular data using GEOID
chi_citstatus_mer <- geo_join(chi_spa_tracts, chi_citstatus_tab_df, "GEOID", "GEOID")
chi_citstatus_mer <- chi_citstatus_mer[chi_citstatus_mer$ALAND>0,]
```


```{r get_chi_lang_asian_tab, results='hide'}
#Getting tabular data 18+, speak asian lang at home, below poverty level (Table B16009)
chi_lang_asian_tab <- acs.fetch(endyear = 2015, span = 5, geography = chi_tab_geo, table.number = "B16001", col.names = "pretty")
chi_lang_asian_tab_df <- data.frame(paste0(str_pad(chi_lang_asian_tab@geography$state, 2, "left", pad="0"), str_pad(chi_lang_asian_tab@geography$county, 3, "left", pad="0"), str_pad(chi_lang_asian_tab@geography$tract, 6, "left", pad="0")), chi_lang_asian_tab@estimate[,c("Language Spoken at Home by Ability to Speak English for the Population 5+ Yrs: Total:","Language Spoken at Home by Ability to Speak English for the Population 5+ Yrs: Chinese:" , "Language Spoken at Home by Ability to Speak English for the Population 5+ Yrs: Mon-Khmer, Cambodian:", "Language Spoken at Home by Ability to Speak English for the Population 5+ Yrs: Thai:", "Language Spoken at Home by Ability to Speak English for the Population 5+ Yrs: Laotian:", "Language Spoken at Home by Ability to Speak English for the Population 5+ Yrs: Vietnamese:", "Language Spoken at Home by Ability to Speak English for the Population 5+ Yrs: Other Asian languages:")], stringsAsFactors = FALSE)
rownames(chi_lang_asian_tab_df)<-1:nrow(chi_lang_asian_tab_df)
names(chi_lang_asian_tab_df)<-c("GEOID", "total", "chinese", "cambodian", "thai", "laotian", "vietnamese", "other")
chi_lang_asian_tab_df$combined <- rowSums(chi_lang_asian_tab_df[,c("chinese", "cambodian", "thai", "laotian", "vietnamese", "other")])
chi_lang_asian_tab_df$percent <- 100*(chi_lang_asian_tab_df$combined/chi_lang_asian_tab_df$total)
```
```{r get_chi_lang_asian_mer, results='hide'}
#Merging spatial data and tabular data using GEOID
chi_lang_asian_mer <- geo_join(chi_spa_tracts, chi_lang_asian_tab_df, "GEOID", "GEOID")
chi_lang_asian_mer <- chi_lang_asian_mer[chi_lang_asian_mer$ALAND>0,]
```


```{r get_chi_race_asian_tab, results='hide'}
#Getting tabular data on race (Table B02001)
chi_race_asian_tab <- acs.fetch(endyear = 2015, span = 5, geography = chi_tab_geo, table.number = "B02001", col.names = "pretty")
chi_race_asian_tab_df <- data.frame(paste0(str_pad(chi_race_asian_tab@geography$state, 2, "left", pad="0"), str_pad(chi_race_asian_tab@geography$county, 3, "left", pad="0"), str_pad(chi_race_asian_tab@geography$tract, 6, "left", pad="0")), chi_race_asian_tab@estimate[,c("Race: Total:" , "Race: Asian alone")], stringsAsFactors = FALSE)
rownames(chi_race_asian_tab_df)<-1:nrow(chi_race_asian_tab_df)
names(chi_race_asian_tab_df)<-c("GEOID", "total", "asian")
chi_race_asian_tab_df$percent <- 100*(chi_race_asian_tab_df$asian/chi_race_asian_tab_df$total)
```
```{r get_chi_race_asian_mer, results='hide'}
#Merging spatial data and tabular data using GEOID
chi_race_asian_mer <- geo_join(chi_spa_tracts, chi_race_asian_tab_df, "GEOID", "GEOID")
chi_race_asian_mer <- chi_race_asian_mer[chi_race_asian_mer$ALAND>0,]
```


```{r get_chi_senior_tab, results='hide'}
chi_senior_tab <- acs.fetch(endyear = 2015, span = 5, geography = chi_tab_geo, table.number = "B09020", col.names = "pretty")
chi_senior_tab_df <- data.frame(paste0(str_pad(chi_senior_tab@geography$state, 2, "left", pad="0"), str_pad(chi_senior_tab@geography$county, 3, "left", pad="0"), str_pad(chi_senior_tab@geography$tract, 6, "left", pad="0")), chi_senior_tab@estimate[,c("Relationship by Household Type (Including Living Alone) for the Population 65 Years and Over: Total:", "Relationship by Household Type (Including Living Alone) for the Population 65 Years and Over: In households: In nonfamily households: Householder: Male: Living alone", "Relationship by Household Type (Including Living Alone) for the Population 65 Years and Over: In households: In nonfamily households: Householder: Female: Living alone")], stringsAsFactors = FALSE)
rownames(chi_senior_tab_df)<-1:nrow(chi_senior_tab_df)
names(chi_senior_tab_df)<-c("GEOID", "total", "male_alone", "female_alone")
chi_senior_tab_df$combined <- rowSums(chi_senior_tab_df[,c("male_alone", "female_alone")])
chi_senior_tab_df$percent <- 100*(chi_senior_tab_df$combined/chi_senior_tab_df$total)
```
```{r get_chi_senior_mer, results='hide'}
#Merging spatial data and tabular data using GEOID
chi_senior_mer <- geo_join(chi_spa_tracts, chi_senior_tab_df, "GEOID", "GEOID")
chi_senior_mer <- chi_senior_mer[chi_senior_mer$ALAND>0,]
```


```{r create_chi_cen_map_helpers, results='hide', warning=FALSE, message=FALSE}
#Adding map elements for each layer
cmaa_clients_map_popup <- paste0("Age: ", cmaa_clients_tab$age, "<br>", "Race: ", cmaa_clients_tab$racecat, "<br>", "Gender: ", cmaa_clients_tab$gender, "<br>", "Citizen: ", cmaa_clients_tab$`us citizen?`, "<br>", "Voter: ", cmaa_clients_tab$`registered to vote?`, "<br>", "Lat: ", cmaa_clients_tab$lat, "<br>", "Long: ", cmaa_clients_tab$long)
cmaa_clients_map_pal <- colorFactor(palette = "Dark2", domain = cmaa_clients_tab$racecat)

comp_locations_map_popup <- paste0("Type: ", comp_locations_map_coords$type, "<br>", comp_locations_map_coords$orgname, "<br>", comp_locations_map_coords$address, "<br>", comp_locations_map_coords$city, ", ", comp_locations_map_coords$state, " ", comp_locations_map_coords$zip, "<br>", "Tel: ", comp_locations_map_coords$phone)
comp_locations_map_pal <- colorFactor(palette = "Set1", domain = comp_locations_map_coords$type)

chi_income_map_popup <- paste0("GEOID: ", chi_income_mer$GEOID, "<br>", "% of HH below 20k (2015): ", round(chi_income_mer$percent,2))
chi_income_map_pal <- colorNumeric(palette = "YlOrRd", domain = chi_income_mer$percent)

chi_citstatus_map_popup <- paste0("GEOID: ", chi_citstatus_mer$GEOID, "<br>", "% of Immigrant Pop.: ", round(chi_citstatus_mer$percent,2))
chi_citstatus_map_pal <- colorNumeric(palette = "Blues", domain = chi_citstatus_mer$percent)

chi_lang_asian_map_popup <- paste0("GEOID: ", chi_lang_asian_mer$GEOID, "<br>", "% of Pop. Speaking Asian<br> Languages at Home (2015): ", round(chi_lang_asian_mer$percent,2))
chi_lang_asian_map_pal <- colorNumeric(palette = "YlGn", domain = chi_lang_asian_mer$percent)

chi_race_asian_map_popup <- paste0("GEOID: ", chi_race_asian_mer$GEOID, "<br>", "% of Total Population, Asian: ", round(chi_race_asian_mer$percent,2))
chi_race_asian_map_pal <- colorNumeric(palette = "YlGn", domain = chi_race_asian_mer$percent)

chi_senior_map_popup <- paste0("GEOID: ", chi_senior_mer$GEOID, "<br>", "% of Seniors Living Alone (2015): ", round(chi_senior_mer$percent,2))
chi_senior_map_pal <- colorNumeric(palette = "BuPu", domain = chi_senior_mer$percent)
```

```{r create_chi_cen_map, results='hide', warning=FALSE, message=FALSE}
#Creating the overall map
chi_cen_map <- leaflet() %>%
  addProviderTiles("CartoDB.Positron", group = "CartoDB") %>%
  addMarkers(cmaa_locations_map_coords$long, cmaa_locations_map_coords$lat, label = as.character(cmaa_locations_map_coords$name), group = "CMAA Markers") %>%
  
  addCircles(cmaa_clients_tab$long, cmaa_clients_tab$lat, popup=cmaa_clients_map_popup, weight = 1.5, radius=2, color=cmaa_clients_map_pal(cmaa_clients_tab$racecat), stroke = TRUE, fillOpacity = 0.7, group = "CMAA Clients") %>% 
  addLegend(pal = cmaa_clients_map_pal, values = cmaa_clients_tab$racecat, position = "topright", title = "CMAA Clients by<br>Racial Category", group = "CMAA Clients") %>%
  
  addCircles(comp_locations_map_coords$long, comp_locations_map_coords$lat, popup=comp_locations_map_popup, weight = 5, radius=8, color = comp_locations_map_pal(comp_locations_map_coords$type), stroke = TRUE, fillOpacity = 0.7, group = "Competing Agencies") %>% 
   addLegend(pal = comp_locations_map_pal, values = comp_locations_map_coords$type, position = "topright", title = "Competing Agency Type", group = "Competing Agencies") %>%
  
  addPolygons(data = chi_income_mer, fillColor = ~chi_income_map_pal(percent), color = "#e2e2e2", fillOpacity = 0.5, weight = 1, smoothFactor = 0.2, popup = chi_income_map_popup, group = "Low-Income Pop.") %>%
  addLegend(pal = chi_income_map_pal, values = chi_income_mer$percent, position = "topright", title = "Percent of Households<br>Below $20,000 Annual<br>Income (2015)", labFormat = labelFormat(suffix = "%"), group = "Low-Income Pop.") %>%
  
  addPolygons(data = chi_citstatus_mer, fillColor = ~chi_citstatus_map_pal(percent), color = "#e2e2e2", fillOpacity = 0.5, weight = 1, smoothFactor = 0.2, popup = chi_citstatus_map_popup, group = "Immigrant Pop.") %>%
  addLegend(pal = chi_citstatus_map_pal, values = chi_citstatus_mer$percent, position = "topright", title = "Percent of Total<br>Pop., Immigrant (2015)", labFormat = labelFormat(suffix = "%"), group = "Immigrant Pop.") %>%
  
  addPolygons(data = chi_lang_asian_mer, fillColor = ~chi_lang_asian_map_pal(percent), color = "#e2e2e2", fillOpacity = 0.5, weight = 1, smoothFactor = 0.2, popup = chi_lang_asian_map_popup, group = "Asian Lang. Pop.") %>%
  addLegend(pal = chi_lang_asian_map_pal, values = chi_lang_asian_mer$percent, position = "topright", title = "Percent of Population<br>Speaking Asian Lang.<br>at Home (2015)", labFormat = labelFormat(suffix = "%"), group = "Asian Lang. Pop.") %>%
  
    addPolygons(data = chi_race_asian_mer, fillColor = ~chi_race_asian_map_pal(percent), color = "#e2e2e2", fillOpacity = 0.5, weight = 1, smoothFactor = 0.2, popup = chi_race_asian_map_popup, group = "Asian Race Pop.") %>%
  addLegend(pal = chi_race_asian_map_pal, values = chi_race_asian_mer$percent, position = "topright", title = "Percent of Total<br>Pop., Asian (2015)", labFormat = labelFormat(suffix = "%"), group = "Asian Race Pop.") %>%
  
  addPolygons(data = chi_senior_mer, fillColor = ~chi_senior_map_pal(percent), color = "#e2e2e2", fillOpacity = 0.5, weight = 1, smoothFactor = 0.2, popup = chi_senior_map_popup, group = "Senior Pop. (Alone)") %>%
  addLegend(pal = chi_senior_map_pal, values = chi_senior_mer$percent, position = "topright", title = "Percent of Seniors<br>Living Alone (2015)", labFormat = labelFormat(suffix = "%"), group = "Senior Pop. (Alone)") %>%

  addLayersControl(baseGroups = c("CartoDB"), overlayGroups = c("CMAA Markers", "CMAA Clients", "Competing Agencies", "Low-Income Pop.", "Immigrant Pop.", "Asian Lang. Pop.", "Asian Race Pop.", "Senior Pop. (Alone)"), position = "bottomright", options = layersControlOptions(collapsed = FALSE)) %>%
  setView(cmaa_locations_map_coords$long[1], cmaa_locations_map_coords$lat[1], zoom = 10) 
```

